name: æŠ“å–å½“æ—¥ç”¨é¤äººæ•°å¹¶æ¨é€åˆ°ä¼ä¸šå¾®ä¿¡ï¼ˆPlaywrightç‰ˆï¼‰

on:
  schedule:
    - cron: '0 0 * * *'          # UTC 01:00 = åŒ—äº¬æ—¶é—´ 08:00
  workflow_dispatch:

jobs:
  stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£… Python ä¾èµ–
        run: |
          pip install playwright beautifulsoup4 lxml
          playwright install chromium

      - name: æŠ“å–å¹¶æ¨é€
        env:
          WECOM_WEBHOOK_KEY: ${{ secrets.WECOM_WEBHOOK_KEY }}
          LUNCH_URL:         ${{ secrets.LUNCH_URL }}
        shell: python
        run: |
          import os, json, requests, sys
          from playwright.sync_api import sync_playwright
          from bs4 import BeautifulSoup

          key     = os.getenv('WECOM_WEBHOOK_KEY')
          url     = os.getenv('LUNCH_URL')
          webhook = f"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key={key}"

          with sync_playwright() as p:
              browser = p.chromium.launch(headless=True)
              page    = browser.new_page()
              try:
                  page.goto(url, wait_until="networkidle", timeout=30000)
                  page.wait_for_timeout(5000)
                  html = page.content()
              except Exception as e:
                  print('âŒ æ‰“å¼€é¡µé¢å¤±è´¥:', e)
                  sys.exit(1)
              finally:
                  browser.close()

          soup = BeautifulSoup(html, "lxml")
          box  = soup.select_one('div.stats-box')
          if not box:
              print('âš ï¸  é¡µé¢ä¸­æ‰¾ä¸åˆ° div.stats-boxï¼Œå‰ 1000 å­—ç¬¦ï¼š')
              print(html[:1000])
              sys.exit(1)

          num   = box.find('div')
          title = box.find('h3')
          if not num or not title:
              print('âš ï¸  stats-box å†…ç¼ºå°‘ div æˆ– h3')
              sys.exit(1)

          md = f"**ğŸ“Š {title.get_text(strip=True)}**\n---> **{num.get_text(strip=True)}** äºº"
          payload = {"msgtype": "markdown", "markdown": {"content": md}}

          try:
              resp = requests.post(webhook, json=payload, timeout=10)
              resp.raise_for_status()
              print('âœ… æ¨é€æˆåŠŸ:', resp.text)
          except Exception as e:
              print('âŒ æ¨é€å¤±è´¥:', e)
              sys.exit(1)
